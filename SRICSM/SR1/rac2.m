%loc1是待配准图片，loc2是参考图片
%function [T,loc14,loc24]=transform(loc1,loc2)
%loc1=[150.800000000000,1765.75000000000;155.310000000000,1635.19000000000;158.050000000000,1694.72000000000;157.710000000000,1693.58000000000;145.790000000000,1853.28000000000;249.280000000000,1557.49000000000;232.520000000000,1588.64000000000;201.110000000000,1615.68000000000;109.320000000000,1594.84000000000;109.320000000000,1594.84000000000;204.950000000000,1632.71000000000;184.030000000000,1756.58000000000;175.920000000000,1716.39000000000;135.820000000000,1847.91000000000;115.660000000000,1547.88000000000;102.400000000000,1621.27000000000;102.400000000000,1621.27000000000;236.140000000000,1608.23000000000;236.140000000000,1608.23000000000;224,1606.03000000000;183,1792.43000000000;125.690000000000,1536.54000000000;348.930000000000,1281.95000000000;192.230000000000,1689.97000000000;182.130000000000,1656.35000000000;125.760000000000,1536.74000000000;171.800000000000,1748.37000000000;];
%loc2=[435.140000000000,1755.71000000000;438.900000000000,1622.49000000000;443.320000000000,1683.77000000000;443.320000000000,1683.77000000000;430.270000000000,1842.28000000000;534.450000000000,1547.09000000000;517.120000000000,1578.04000000000;486.360000000000,1604.85000000000;394.160000000000,1583.31000000000;394.160000000000,1583.31000000000;490.270000000000,1621.22000000000;469.140000000000,1745.81000000000;460.690000000000,1705.92000000000;420.870000000000,1837.17000000000;400.100000000000,1537.74000000000;386.920000000000,1610.85000000000;386.920000000000,1610.85000000000;520.330000000000,1598.04000000000;520.330000000000,1598.04000000000;508.400000000000,1595.12000000000;468.450000000000,1781.10000000000;410.350000000000,1525.77000000000;634.200000000000,1270.98000000000;476.990000000000,1679.87000000000;466.620000000000,1646.23000000000;410.350000000000,1525.77000000000;456.220000000000,1738.15000000000;];
function [T,loc22]=rac2(loc1,loc2)
loc1=loc1(:,1:2);
loc2=loc2(:,1:2);
N=size(loc1,1);
iter=N*(N-1)*(N-2)*(N-3)/24;
SEL=zeros(iter,4);
count=1;
%num=4;
%loc1OfExceptSel=loc1;
%loc2OfExceptSel=loc2;
for i=1:N-3
    for j=2:N-2
        for k=3:N-1
            for q=4:N
              if i<j && j<k&&k<q
                  SEL(count,:)=[i j k q];
                  count=count+1;
              end
            end
        end
    end
end
vel=zeros(iter,N);
distance=zeros(iter,N);
t=cell(1,iter);
loc1new=[ loc1';ones(1,N)];%相当于t*xy1=xy2；
loc2new=[ loc2';ones(1,N)];
for k=1:iter
sel=SEL(k,:);
x1=loc1(sel,1);y1=loc1(sel,2);%取这4d对点进行变换矩阵的计算
x2=loc2(sel,1);y2=loc2(sel,2);

A=[x1(1)  y1(1)   1        0          0        0       -x2(1)*x1(1)        -x2(1)*y1(1);
    0      0      0      x1(1)      y1(1)      1       -y2(2)*x1(1)        -y2(2)*y1(1);
   x1(2)  y1(2)   1        0          0        0       -x2(2)*x1(2)        -x2(2)*y1(2);
    0      0      0      x1(2)      y1(2)      1       -y2(2)*x1(2)        -y2(2)*y1(2);
   x1(3)  y1(3)   1        0          0        0       -x2(3)*x1(3)        -x2(3)*y1(3);
    0      0      0      x1(3)      y1(3)      1       -y2(3)*x1(3)        -y2(3)*y1(3);
   x1(4)  y1(4)   1        0          0        0       -x2(4)*x1(4)        -x2(4)*y1(4);
    0      0      0      x1(4)      y1(4)      1       -y2(4)*x1(4)        -y2(4)*y1(4);];
B=[x2(1) y2(1) x2(2) y2(2) x2(3) y2(3) x2(4) y2(4)]';
%H=inv(A)*B;
H=A\B;
H=[H(1) H(2) H(3);H(4) H(5) H(6);H(7) H(8) 1];
t{k}=H;
loc2trans=t{k}*loc1new;
x=(loc2trans(1,:)-loc2new(1,:)).^2;
y=(loc2trans(2,:)-loc2new(2,:)).^2;
distance(k,:)=sqrt(x+y);%行向量
a=find(distance(k,:)<2);
vel(k,1:size(a,2))=a;
end
%返回vel中
num=sum(vel~=0,2);%%%vel中不为0的个数
nummax=max(num);
nummaxvel= num==nummax;
dis=sum(distance,2);
dismax=dis(nummaxvel,:);
dismin=find(dis==min(dismax));
T=t{dismin(1)};
%Sel=zeros(dismin,4);
loc22=T*loc1new;


